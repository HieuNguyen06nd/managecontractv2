<main class="main-content container py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="page-title mb-1">Hợp đồng chờ Phê duyệt</h1>
      <p class="page-subtitle m-0">Quản lý và xử lý các hợp đồng đang chờ phê duyệt của bạn</p>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <input class="form-control" style="min-width:260px" placeholder="Tìm theo tiêu đề/số HĐ/mẫu..." [(ngModel)]="searchTerm">
      <select class="form-select" style="min-width:180px" [(ngModel)]="sortBy">
        <option [ngValue]="''">Sắp xếp: Mặc định</option>
        <option [ngValue]="'newest'">Sắp xếp: Mới nhất</option>
        <option [ngValue]="'oldest'">Sắp xếp: Cũ nhất</option>
        <option [ngValue]="'name'">Sắp xếp: Theo tên</option>
      </select>
    </div>
  </div>

  <!-- Filter tabs -->
  <div class="filter-section mb-3">
    <div class="d-flex flex-wrap gap-2">
      <button class="filter-tag" [class.active]="filterTab==='all'" (click)="onTabChange('all')">Tất cả</button>
      <button class="filter-tag" [class.active]="filterTab==='PENDING_APPROVAL'" (click)="onTabChange('PENDING_APPROVAL')">Chờ duyệt</button>
      <button class="filter-tag" [class.active]="filterTab==='APPROVED'" (click)="onTabChange('APPROVED')">Đã duyệt</button>
      <button class="filter-tag" [class.active]="filterTab==='REJECTED'" (click)="onTabChange('REJECTED')">Từ chối</button>
      <div class="ms-auto d-flex align-items-center gap-2">
        <span class="text-muted">Loại</span>
        <select class="form-select" style="min-width:180px" [(ngModel)]="typeFilter">
          <option [ngValue]="''">Tất cả</option>
          <option [ngValue]="'labor'">Hợp đồng lao động</option>
          <option [ngValue]="'sale'">Hợp đồng mua bán</option>
          <option [ngValue]="'rental'">Hợp đồng thuê</option>
          <option [ngValue]="'service'">Hợp đồng dịch vụ</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Loading / Error -->
  <div *ngIf="loading" class="alert alert-info d-flex align-items-center gap-2">
    <i class="fas fa-spinner fa-spin"></i> Đang tải danh sách...
  </div>
  <div *ngIf="!loading && errorMsg" class="alert alert-danger">{{ errorMsg }}</div>

  <!-- Empty -->
  <div *ngIf="!loading && !errorMsg && visibleContracts.length === 0" class="alert alert-secondary">
    Không có hợp đồng nào phù hợp.
  </div>

  <!-- Contracts -->
  <div class="contracts-container" *ngIf="!loading && !errorMsg">
    <div class="contract-card" *ngFor="let c of visibleContracts; trackBy: trackById">
      <div class="contract-header">
        <span class="contract-badge" [ngClass]="badgeClass(c.status)">
          {{ ((c.status || 'PENDING_APPROVAL').split('_').join(' ')) | uppercase }}
        </span>
        <div class="priority-tag" *ngIf="c.priority==='HIGH'">KHẨN CẤP</div>
        <h3 class="contract-title">{{ c.title || c.contractNumber }}</h3>

        <div class="contract-meta">
          <div class="meta-item"><i class="fas fa-hashtag"></i><span>{{ c.contractNumber }}</span></div>
          <div class="meta-item" *ngIf="c.templateName"><i class="fas fa-file-alt"></i><span>{{ c.templateName }}</span></div>
          <div class="meta-item" *ngIf="c.createdAt"><i class="fas fa-calendar"></i><span>{{ formatDate(c.createdAt) }}</span></div>
          <div class="meta-item" *ngIf="c.currentStepAction">
            <i class="fas fa-stamp"></i>
            <span>Hành động:
              <b>
                {{ c.currentStepAction === 'APPROVE_ONLY' ? 'PHÊ DUYỆT'
                   : c.currentStepAction === 'SIGN_ONLY' ? 'KÝ'
                   : 'KÝ rồi PHÊ DUYỆT' }}
              </b>
            </span>
          </div>
        </div>
      </div>

      <div class="contract-body">
        <div class="current-step" *ngIf="c.currentStepName">
          <div class="step-label">Bước hiện tại:</div>
          <div class="step-value">{{ c.currentStepName }}</div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-preview" (click)="openPreview(c)">
            <i class="fas fa-eye me-1"></i> Xem trước
          </button>

          <button class="btn btn-sign" *ngIf="canSign(c)" (click)="openSign(c)">
            <i class="fas fa-signature me-1"></i> Ký trên PDF
          </button>

          <button class="btn btn-approve"
                  *ngIf="canApproveVisible(c)"
                  [disabled]="approveDisabled(c)"
                  (click)="openApprove(c)">
            <i class="fas fa-check me-1"></i> Phê duyệt
          </button>

          <button class="btn btn-reject" *ngIf="canReject(c)" (click)="openReject(c)">
            <i class="fas fa-times me-1"></i> Từ chối
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Approve Modal -->
  <div class="modal-backdrop" *ngIf="approvalOpen"></div>
  <div class="modal-panel" *ngIf="approvalOpen">
    <div class="modal-card">
      <div class="modal-header">
        <h5 class="modal-title text-success">
          <i class="fas fa-check-circle me-2"></i> Phê duyệt Hợp đồng
        </h5>
        <button class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <p *ngIf="current">
          Xác nhận phê duyệt hợp đồng: <strong>{{ current.title || current.contractNumber }}</strong>
        </p>
        <div class="alert alert-warning" *ngIf="current?.currentStepAction==='SIGN_THEN_APPROVE' && !current?.currentStepSigned">
          <i class="fas fa-exclamation-triangle me-2"></i> Bước này yêu cầu <b>ký trước</b> khi phê duyệt.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeModals()">Hủy</button>
        <button class="btn btn-success" [disabled]="!current" (click)="approve(current!)">Xác nhận Phê duyệt</button>
      </div>
    </div>
  </div>

  <!-- Reject Modal -->
  <div class="modal-backdrop" *ngIf="rejectionOpen"></div>
  <div class="modal-panel" *ngIf="rejectionOpen">
    <div class="modal-card">
      <div class="modal-header">
        <h5 class="modal-title text-danger">
          <i class="fas fa-times-circle me-2"></i> Từ chối Phê duyệt
        </h5>
        <button class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning" *ngIf="current">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Bạn đang từ chối hợp đồng: <strong>{{ current.title || current.contractNumber }}</strong>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Lý do từ chối *</label>
          <select class="form-select" [(ngModel)]="rejectReasonCode" required>
            <option value="">Chọn lý do từ chối</option>
            <option value="missing_info">Thiếu thông tin cần thiết</option>
            <option value="incorrect_info">Thông tin không chính xác</option>
            <option value="policy_violation">Vi phạm chính sách công ty</option>
            <option value="format_error">Sai định dạng / mẫu</option>
            <option value="budget_issue">Vấn đề ngân sách</option>
            <option value="other">Lý do khác</option>
          </select>
        </div>

        <div class="mb-2">
          <label class="form-label fw-semibold">Mô tả chi tiết *</label>
          <textarea class="form-control" rows="4" [(ngModel)]="rejectComment" placeholder="Mô tả cụ thể lý do từ chối..." required></textarea>
        </div>

        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="allowResubmission" [(ngModel)]="allowResubmission">
          <label class="form-check-label" for="allowResubmission">Cho phép gửi lại sau khi chỉnh sửa</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeModals()">Hủy</button>
        <button class="btn btn-danger" [disabled]="!current" (click)="reject(current!)">Xác nhận Từ chối</button>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal-backdrop" *ngIf="previewOpen" (click)="closePreview()"></div>
  <div class="modal-panel modal-panel--xl" *ngIf="previewOpen" (click)="closePreview()">
    <div class="modal-card modal-card--xl" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h5 class="modal-title d-flex align-items-center gap-2 m-0">
          <i class="fas fa-eye"></i>
          Xem trước: {{ current?.title || current?.contractNumber || 'Hợp đồng' }}
        </h5>
        <button class="btn-close" (click)="closePreview()" aria-label="Đóng"></button>
      </div>

      <div class="modal-toolbar">
        <div class="left d-flex align-items-center gap-2">
          <span class="contract-badge" [ngClass]="badgeClass(current?.status)">
            {{ ((current?.status || 'PENDING_APPROVAL').split('_').join(' ')) | uppercase }}
          </span>
          <span class="text-muted" *ngIf="current?.contractNumber">#{{ current?.contractNumber }}</span>
        </div>

        <div class="right d-flex align-items-center gap-2">
          <button class="btn btn-outline-secondary" (click)="reloadPreview()">
            <i class="fas fa-rotate me-1"></i> Tải lại
          </button>

          <!-- Tải ảnh chữ ký & bật đặt -->
          <label class="btn btn-outline-primary mb-0">
            <input type="file" class="d-none" accept="image/png,image/jpeg"
                   (change)="onUploadSignatureFile($event)" />
            <i class="fas fa-upload me-1"></i> Tải ảnh chữ ký
          </label>

          <button class="btn btn-outline-primary" (click)="startPlaceSignature()">
            <i class="fas fa-pen-nib me-1"></i> Bật đặt chữ ký
          </button>

          <a class="btn btn-outline-primary" *ngIf="previewDownloadUrl"
             [href]="previewDownloadUrl" target="_blank" rel="noopener">
            <i class="fas fa-download me-1"></i> Tải xuống
          </a>

          <button class="btn btn-approve" (click)="closePreview()">Đóng</button>
        </div>
      </div>

      <div class="modal-body p-0">
        <div *ngIf="pdfLoading" class="p-3 text-muted">
          <i class="fas fa-spinner fa-spin me-2"></i> Đang tải file xem trước...
        </div>

        <div *ngIf="pdfError" class="alert alert-danger m-3">
          {{ pdfError }}
        </div>

        <div class="pdf-viewer-wrap">
          <ngx-extended-pdf-viewer
            *ngIf="!pdfLoading && !pdfError && pdfBlobUrl"
            [src]="pdfBlobUrl"
            useBrowserLocale="true"
            [height]="'100%'"
            [textLayer]="true"
            [showSidebarButton]="true"
            [showPresentationModeButton]="true"
            [showOpenFileButton]="false"
            [showPrintButton]="true"
            [showDownloadButton]="false"
            [handTool]="false"
            [zoom]="'page-width'"
            (pagesLoaded)="computePdfHostRectAndPages()"
            (pageRendered)="computePdfHostRectAndPages()"
            [filenameForDownload]="current?.contractNumber || 'contract.pdf'">
          </ngx-extended-pdf-viewer>

          <!-- GHOST ảnh chữ ký (kéo thả/đổi size) -->
          <div
            *ngIf="sigGhostVisible && sigImgSrc"
            class="sig-ghost"
            [ngStyle]="{
              left: (sig.left - scroll.left) + 'px',
              top:  (sig.top  - scroll.top)  + 'px',
              width:  sig.width + 'px',
              height: sig.height + 'px'
            }"
            (mousedown)="startDrag($event)"
          >
            <img [src]="sigImgSrc" draggable="false" />
            <div class="resize-handle" (mousedown)="startResize($event)"></div>
          </div>


        </div>

        <div class="sign-toolbar" *ngIf="placingMode">
          <span class="me-2"><i class="fas fa-signature"></i> Chế độ đặt chữ ký</span>
          <button class="btn btn-sm btn-outline-secondary" (click)="computePdfHostRectAndPages()">Căn lại</button>
          <button class="btn btn-sm btn-outline-secondary" (click)="sigGhostVisible = !sigGhostVisible">
            {{ sigGhostVisible ? 'Ẩn' : 'Hiện' }} chữ ký
          </button>
          <button class="btn btn-sm btn-outline-danger" (click)="placingMode=false; sigGhostVisible=false">Thoát đặt</button>
          <button class="btn btn-sm btn-success ms-auto" (click)="confirmDragSign()">
            <i class="fas fa-check"></i> Xác nhận ký
          </button>
        </div>
      </div>
    </div>
  </div>
</main>
