<main class="main-content">
  <h1 class="page-title">
    <i class="fas fa-upload"></i>
    Tải lên hợp đồng
  </h1>

  <!-- Step indicator -->
  <div class="steps">
    <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
      <div class="step-number">1</div>
      <div class="step-text">Tải lên hợp đồng</div>
    </div>
    <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
      <div class="step-number">2</div>
      <div class="step-text">Xác định biến</div>
    </div>
    <div class="step" [class.active]="currentStep === 3">
      <div class="step-number">3</div>
      <div class="step-text">Hoàn thành</div>
    </div>
  </div>

  <!-- Bước 1: Upload -->
  <div *ngIf="currentStep === 1" class="upload-container">
    <!-- Giữ nguyên phần upload từ file và link -->
    <div class="tabs">
      <div class="tab" [class.active]="activeTab === 'file'" (click)="setActiveTab('file')">
        Tải lên từ file
      </div>
      <div class="tab" [class.active]="activeTab === 'link'" (click)="setActiveTab('link')">
        Tải lên từ Google Docs
      </div>
    </div>

    <div class="tab-content">
      <!-- File Upload -->
      <div class="tab-pane" [class.active]="activeTab === 'file'">
        <div class="form-group">
          <label class="form-label">Chọn file hợp đồng (.docx, tối đa {{ maxFileMB }}MB)</label>

          <div class="file-drop-area"
               [class.drag-active]="dragActive"
               (dragenter)="onDragEnter($event)"
               (dragleave)="onDragLeave($event)"
               (dragover)="onDragOver($event)"
               (drop)="onFileDropped($event)"
               (click)="triggerFileInput()">
            <i class="fas fa-cloud-upload-alt"></i>
            <div class="file-drop-text">
              Kéo thả file vào đây hoặc <u>click</u> để chọn file
            </div>

            <input
              type="file"
              #fileInput
              class="file-input"
              (change)="onFileSelected($event)"
              accept=".docx"
              hidden
            />

            <div class="file-name" *ngIf="selectedFile; else noFile">
              <i class="far fa-file-word me-1"></i>
              {{ selectedFile.name }} — {{ formatBytes(selectedFile.size || 0) }}
              <button type="button" class="btn btn-sm btn-outline-danger ms-2" (click)="removeSelectedFile($event)">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <ng-template #noFile>
              <div class="file-name text-muted">Chưa có file nào được chọn</div>
            </ng-template>
          </div>

          <!-- Lỗi inline -->
          <small class="text-danger d-block mt-1" *ngIf="inlineError">{{ inlineError }}</small>
        </div>
      </div>

      <!-- Link Upload -->
      <div class="tab-pane" [class.active]="activeTab === 'link'">
        <div class="form-group">
          <label class="form-label">Link Google Docs (share Anyone with link)</label>
          <input type="url"
                 class="form-control"
                 [(ngModel)]="docLink"
                 placeholder="https://docs.google.com/document/d/..."
                 (focus)="resetMessages()" />
        </div>
      </div>

      <button class="btn btn-primary"
              (click)="previewTemplate()"
              [disabled]="isLoading || (activeTab==='file' && !selectedFile && !docLink)">
        <i class="fas" [ngClass]="isLoading ? 'fa-spinner fa-spin' : 'fa-upload'"></i>
        <span class="ms-2">{{ isLoading ? 'Đang xử lý...' : 'Tải lên và trích xuất biến' }}</span>
      </button>

      <div class="progress-container" *ngIf="isLoading">
        <div class="progress-bar">
          <div class="progress" [style.width.%]="progress"></div>
        </div>
        <div class="progress-text">Đang xử lý: {{ progress }}%</div>
      </div>
    </div>
  </div>

  <!-- Bước 2: Chọn biến -->
  <div *ngIf="currentStep === 2" class="variables-container">
    <div class="variables-header">
      <h2>Các biến đã trích xuất</h2>
      <p>Đặt tên và chọn kiểu dữ liệu cho từng biến, sau đó tạo template</p>
    </div>

    <div class="variables-body">
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label required-field">Tên Template</label>
            <input type="text"
                  class="form-control"
                  [(ngModel)]="templateName"
                  placeholder="Nhập tên template" />
            <div *ngIf="!templateName" class="text-danger small mt-1">
              Tên template là bắt buộc.
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label">Danh mục</label>
            <select class="form-control" [(ngModel)]="selectedCategoryId">
              <option [ngValue]="null">-- Chọn danh mục --</option>
              <option *ngFor="let category of categories" [ngValue]="category.id">
                {{ category.name }}
              </option>
            </select>
            <div *ngIf="isLoadingCategories" class="text-muted small mt-1">
              <i class="fas fa-spinner fa-spin"></i> Đang tải danh mục...
            </div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Mô tả</label>
        <textarea class="form-control"
                  [(ngModel)]="templateDescription"
                  rows="2"
                  placeholder="Nhập mô tả ngắn về template..."></textarea>
      </div>

      <!-- Hiển thị thông tin category đã chọn -->
      <div class="category-info mb-3" *ngIf="selectedCategoryId">
        <small class="text-muted">
          <i class="fas fa-info-circle"></i>
          Đã chọn danh mục: <strong>{{ getCategoryName(selectedCategoryId) }}</strong>
        </small>
      </div>

      <div class="category-info mb-3" *ngIf="!selectedCategoryId">
        <small class="text-warning">
          <i class="fas fa-exclamation-triangle"></i>
          Chưa chọn danh mục. Template sẽ được lưu không phân loại.
        </small>
      </div>

      <table class="variables-table" *ngIf="extractedVariables.length > 0">
        <thead>
          <tr>
            <th width="25%">Tên trường</th>
            <th width="20%">Tên biến</th>
            <th width="15%">Kiểu dữ liệu</th>
            <th width="10%">Bắt buộc</th>
            <th width="30%">Cấu hình</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let variable of extractedVariables; let i = index">
            <td>
              <input type="text" 
                    class="form-control" 
                    [(ngModel)]="variable.name" 
                    placeholder="Nhập tên trường" 
                    [class.is-invalid]="!variable.name.trim()" />
              <div *ngIf="!variable.name.trim()" class="text-danger small mt-1">
                Tên trường là bắt buộc
              </div>
            </td>
            <td>
              <input type="text" class="form-control" [value]="variable.varName" readonly />
              <small class="text-muted">Biến gốc từ template</small>
            </td>
            <td>
              <select [(ngModel)]="variable.varType" (change)="onVariableTypeChange(variable)" class="form-control">
                <option [value]="VariableType.TEXT">Văn bản</option>
                <option [value]="VariableType.NUMBER">Số</option>
                <option [value]="VariableType.DATE">Ngày tháng</option>
                <option [value]="VariableType.BOOLEAN">Boolean</option>
                <option [value]="VariableType.DROPDOWN">Dropdown</option>
                <option [value]="VariableType.LIST">Danh sách</option>
                <option [value]="VariableType.TABLE">Bảng</option>
                <option [value]="VariableType.TEXTAREA">Văn bản dài</option>
              </select>
            </td>
            <td class="text-center">
              <input type="checkbox" [(ngModel)]="variable.required" />
            </td>
            <td>
              <!-- Cấu hình cho Boolean -->
              <div *ngIf="variable.varType === VariableType.BOOLEAN" class="config-panel">
                <div class="row">
                  <div class="col-6">
                    <label>Nhãn True:</label>
                    <input type="text" class="form-control form-control-sm" 
                          [(ngModel)]="variable.config.trueLabel"
                          [placeholder]="getBooleanConfig(variable).trueLabel">
                  </div>
                  <div class="col-6">
                    <label>Nhãn False:</label>
                    <input type="text" class="form-control form-control-sm"
                          [(ngModel)]="variable.config.falseLabel"
                          [placeholder]="getBooleanConfig(variable).falseLabel">
                  </div>
                </div>
              </div>

              <!-- Cấu hình cho Dropdown -->
              <div *ngIf="variable.varType === VariableType.DROPDOWN" class="config-panel">
                <label>Danh sách lựa chọn:</label>
                
                <!-- ĐẢM BẢO: Sử dụng getter method để lấy options -->
                <div *ngFor="let option of getDropdownOptions(variable); let i = index" class="option-item">
                  <div class="input-group input-group-sm mb-1">
                    <input type="text" class="form-control" 
                          [(ngModel)]="getDropdownOptions(variable)[i]"
                          (ngModelChange)="onDropdownOptionChange(variable, i, $event)"
                          [placeholder]="'Option ' + (i + 1)">
                    <button class="btn btn-outline-danger" type="button" 
                            (click)="removeOption(variable, i)" 
                            [disabled]="getDropdownOptions(variable).length <= 1">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <button class="btn btn-sm btn-outline-primary" (click)="addOption(variable)">
                  <i class="fas fa-plus"></i> Thêm option
                </button>
              </div>

              <!-- Cấu hình cho Table -->
              <div *ngIf="variable.varType === VariableType.TABLE" class="config-panel">
                <label>Tên bảng:</label>
                <input type="text" class="form-control form-control-sm mb-2"
                      [(ngModel)]="variable.config.tableName"
                      [placeholder]="getTableConfig(variable).tableName">
                
                <label>Columns:</label>
                <div *ngFor="let column of getTableConfig(variable).columns; let i = index" class="column-item mb-2 p-2 border">
                  <div class="row">
                    <div class="col-5">
                      <input type="text" class="form-control form-control-sm"
                            [(ngModel)]="column.name"
                            placeholder="Tên cột">
                    </div>
                    <div class="col-4">
                      <select class="form-control form-control-sm" 
                              [(ngModel)]="column.type"
                              (ngModelChange)="onColumnTypeChange(column)">
                        <option [value]="VariableType.TEXT">Text</option>
                        <option [value]="VariableType.NUMBER">Số</option>
                        <option [value]="VariableType.DATE">Ngày</option>
                      </select>
                    </div>
                    <div class="col-3">
                      <button class="btn btn-sm btn-outline-danger" 
                              (click)="removeColumn(variable, i)" 
                              [disabled]="getTableConfig(variable).columns.length <= 1">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <button class="btn btn-sm btn-outline-primary" (click)="addColumn(variable)">
                  <i class="fas fa-plus"></i> Thêm cột
                </button>
              </div>

              <!-- Cấu hình cho List -->
              <div *ngIf="variable.varType === VariableType.LIST" class="config-panel">
                <label>Danh sách giá trị:</label>
                
                <!-- ĐẢM BẢO: Sử dụng getter method để lấy items -->
                <div *ngFor="let item of getListItems(variable); let i = index" class="option-item">
                  <div class="input-group input-group-sm mb-1">
                    <input type="text" class="form-control" 
                          [(ngModel)]="getListItems(variable)[i]"
                          (ngModelChange)="onListItemChange(variable, i, $event)"
                          [placeholder]="'Giá trị ' + (i + 1)">
                    <button class="btn btn-outline-danger" type="button" 
                            (click)="removeListItem(variable, i)" 
                            [disabled]="getListItems(variable).length <= 1">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <button class="btn btn-sm btn-outline-primary" (click)="addListItem(variable)">
                  <i class="fas fa-plus"></i> Thêm giá trị
                </button>
              </div>

              <!-- Cấu hình cho Textarea -->
              <div *ngIf="variable.varType === VariableType.TEXTAREA" class="config-panel">
                <label>Số dòng:</label>
                <input type="number" class="form-control form-control-sm"
                      [(ngModel)]="variable.config.rows"
                      [placeholder]="getTextareaConfig(variable).rows.toString()"
                      min="2" max="10">
              </div>

              <!-- Cấu hình cho Number -->
              <div *ngIf="variable.varType === VariableType.NUMBER" class="config-panel">
                <div class="row">
                  <div class="col-6">
                    <label>Min:</label>
                    <input type="number" class="form-control form-control-sm"
                          [(ngModel)]="variable.config.min"
                          [placeholder]="getNumberConfig(variable).min.toString()">
                  </div>
                  <div class="col-6">
                    <label>Max:</label>
                    <input type="number" class="form-control form-control-sm"
                          [(ngModel)]="variable.config.max"
                          [placeholder]="getNumberConfig(variable).max.toString()">
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <div *ngIf="!extractedVariables.length" class="alert alert-warning">
        <p>Không có biến trích xuất từ hợp đồng, bạn vẫn có thể tiếp tục mà không cần nhập biến.</p>
      </div>

      <div class="buttons">
        <button class="btn btn-primary"
                (click)="onCreateOrUpdateTemplate()"
                [disabled]="isLoading || !templateName || !isFieldNameValid()">
          <i class="fas" [ngClass]="finalizedTemplate ? 'fa-save' : 'fa-plus'"></i>
          <span>
            {{ finalizedTemplate ? 'Cập nhật template' : 'Tạo template' }}
          </span>
        </button>
        
        <button class="btn btn-outline-secondary ms-2" (click)="currentStep = 1">
          <i class="fas fa-arrow-left"></i> Quay lại
        </button>
      </div>
    </div>
  </div>

  <!-- Bước 3: Hoàn thành -->
  <div *ngIf="currentStep === 3" class="completed-container">
    <h2> Hoàn thành</h2>
    <p>Hợp đồng đã được lưu thành công.</p>
  </div>

  <!-- Alerts -->
  <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="alert alert-error">{{ errorMessage }}</div>
</main>